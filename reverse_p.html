<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<title>Trapped Knight</title>
</head><body>
<style>#spiral td{width:25px;height:25px;text-align:center;font-size:80%;font-weight:bold}</style>

<table id="spiral" border="2"></table>
<div id="result"></div>

<script>
"use strict";

// given a coordinate, returns the number in it. Square-shaped version
function getNum_square(x,y) {
	let loop = Math.max(Math.abs(x),Math.abs(y));
	let start = (2*loop-1)*(2*loop-1)+1;

	if (!x && !y) return 1;

	if (x === loop && y !== loop) return start-y+loop-1;
	if (y === -loop) return start-x+3*loop-1;
	if (x === -loop) return start+y+5*loop-1;
	return start+x+7*loop-1;
}
// given a coordinate, return the number in it. Diamond-shaped version
function getNum_diamond(x,y) {
	let loop = Math.abs(x)+Math.abs(y);
	let start = 4*loop*(loop-1)/2+2;

	if (!x && !y) return 1;

	if (x>0 && y>=0) return start+x-1;
	if (x>0) return start+2*loop-x-1;
	if (y<0) return start+3*loop+y-1;
	return start+4*loop+x-1;
}





var allPrimes = [2,3];
var setPrimes = new Set(allPrimes);
var biggestPrime = 3;

function genPrimes() {
	let i = biggestPrime;
	while(true) {
		++i;
		if (allPrimes.some(p => i % p === 0)) continue;
		biggestPrime = i;
		allPrimes.push(i);
		setPrimes.add(i);
		return;
	}
}

var ordered = [0,1];
var orderedNextLoop = 0;
var orderedLastComposite = 1;
function growOrdered() {
	let pp = allPrimes[orderedNextLoop++];
	// add pp non-primes...
	let temp = [];
	for (let i=0; i<pp; ++i) {
		orderedLastComposite++;
		if (orderedLastComposite > biggestPrime) genPrimes();
		while (setPrimes.has(orderedLastComposite)) orderedLastComposite++;
		temp.push(orderedLastComposite);
	}
	// in the opposite order
	while (temp.length) ordered.push(temp.pop());

	ordered.push(pp);
}

function getOrdered(num) {
	while (!ordered[num]) growOrdered();
	num = ordered[num];
	return num;
}


function getNum_square_p(x,y) {
	return getOrdered( getNum_square(x,y) );
}
function getNum_diamond_p(x,y) {
	return getOrdered( getNum_diamond(x,y) );
}


var getNum;





function showCenter(size) {
	let table = document.getElementById("spiral");
	for (let y=-size;y<=size;++y) {
		let tr = document.createElement("tr");
		for (let x=-size;x<=size;++x) {
			let td = document.createElement("td");
			td.textContent = getNum(x,y);
			tr.appendChild(td);
		}
		table.appendChild(tr);
	}
}



function solve(max=10000, echo=false) {
	let visited = new Set();
	let bestN, bestX, bestY;

	let posX = 0, posY = 0;
	let step = 1;
	visited.add(getNum(0,0));
	if (echo) console.log(`${step}. (${posX},${posY}): 1`);

	function tryNext(x,y) {
		let num = getNum(x,y);
		if (visited.has(num)) return;

		if (bestN && num > bestN) return;
		bestN = num;
		bestX = x;
		bestY = y;
	}

	while (--max) {
		bestN = bestX = bestY = 0;
		tryNext(posX-1,posY-2);
		tryNext(posX-1,posY+2);
		tryNext(posX+1,posY-2);
		tryNext(posX+1,posY+2);
		tryNext(posX-2,posY-1);
		tryNext(posX-2,posY+1);
		tryNext(posX+2,posY-1);
		tryNext(posX+2,posY+1);
		if (!bestN) {
			document.getElementById("result").textContent = `trapped after step #${step} at (${posX},${posY}): ` + getNum(posX,posY);
			return;
		}
		step++;
		posX = bestX;
		posY = bestY;
		visited.add(bestN);
		if (echo) console.log(`${step}. (${bestX},${bestY}): ${bestN}`);
	}

	document.getElementById("result").textContent = `still free after step #${step} at (${posX},${posY}): ` + getNum(posX,posY);
}




//getNum = getNum_square;
//getNum = getNum_diamond;
getNum = getNum_square_p;
//getNum = getNum_diamond_p;
showCenter(5);
solve(10000, true);


</script></body></html>
