<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<title>Trapped Knight</title>
</head><body>
<style>
#spiral td{width:35px;height:25px;text-align:center;font-size:80%;font-weight:bold}
#mover td{text-align:center}
#mover button{font-size:200%;width:50px;height:50px;display:flex;justify-content:center}
</style>

Sequence:<select id="selSeq" onchange="run()"></select> &nbsp; Coordinates:<select id="selCoord" onchange="run()"></select>
<br>
Knight begins at
<input id="iniX" type="number" value="0" required style="text-align:center;width:4em" onchange="run()">,
<input id="iniY" type="number" value="0" required style="text-align:center;width:4em" onchange="run()">
<hr>

<table id="spiral" border="2"></table>
<div id="result"></div>

<div style="position:absolute;top:0;right:0;background:#eee;border:1px solid black;padding:.5em">
	<table id="mover">
		<tr>
			<td></td>
			<td><button onclick="showY--;showBoard()">⇧</button></td>
			<td></td>
			<td><button onclick="showSize++;showBoard()">+</button></td>
		</tr><tr>
			<td><button onclick="showX--;showBoard()">⇦</button></td>
			<td><button onclick="showX=showY=0;showBoard()">•</button></td>
			<td><button onclick="showX++;showBoard()">⇨</button></td>
		</tr><tr>
			<td></td>
			<td><button onclick="showY++;showBoard()">⇩</button></td>
			<td></td>
			<td><button onclick="showSize=Math.max(1,showSize-1);showBoard()">-</button></td>
		</tr><tr>
			<td colspan="4" id="moveCoords"></td>
		</tr>
	</table>
</div>

<script>
"use strict";

////////////////////////////////////////////////////////////////////////////////////////////////////

var Prime = {
	_list : [2,3], // list of all primes
	_more : function() { // calculate next prime
		let n = this._list[this._list.length-1];
		while(true) {
			n += 2;
			let fail = false;
			let len = this._list.length;
			for (let i=0; i<len; ++i) {
				let p = this._list[i];
				if (p*p > n) break;
				if (n % p !== 0) continue;
				fail = true;
				break;
			}
			if (!fail) break;
		}
		this._list.push(n);
	},

	get : function(n) { // get nth prime number
		while (n >= this._list.length) this._more();
		return this._list[n];
	},
	is : function(n) { // is this number prime?
		while (n > this._list[this._list.length-1]) this._more();
		return this._list.some(p => n===p); // TODO: optimize
	},
};

////////////////////////////////////////////////////////////////////////////////////////////////////

var sequences = new Map;

// returns the nth natural number
sequences.set("Normal", {
	get : function(n) {
		return n;
	},
});



// returns the nth number in the mathatrutgers' sequence
sequences.set("Mathatrutgers", {
	_list : [0,1],
	_nextPrime : 0,
	_lastComposite : 1,
	_grow : function() {
		let pp = Prime.get(this._nextPrime++);
		// add pp non-primes...
		for (let i=0; i<pp; ++i) {
			this._lastComposite++;
			while (Prime.is(this._lastComposite)) this._lastComposite++;
			this._list.push(this._lastComposite);
		}

		this._list.push(pp);
	},

	get : function(n) {
		while (!this._list[n]) this._grow();
		return this._list[n];
	},
});

// returns the nth number in the mathatrutgers' reverse sequence
sequences.set("Reverse Mathatrutgers", {
	_list : [0,1],
	_nextPrime : 0,
	_lastComposite : 1,
	_grow : function() {
		let pp = Prime.get(this._nextPrime++);
		// add pp non-primes...
		let temp = [];
		for (let i=0; i<pp; ++i) {
			this._lastComposite++;
			while (Prime.is(this._lastComposite)) this._lastComposite++;
			temp.push(this._lastComposite);
		}
		// in the opposite order
		while (temp.length) this._list.push(temp.pop());

		this._list.push(pp);
	},

	get : function(n) {
		while (!this._list[n]) this._grow();
		return this._list[n];
	},
});

sequences.set("Bad Mathatrutgers", {
	_list : [0,1],
	_nextPrime : 0,
	_lastComposite : 1,
	_grow : function() {
		let pp = Prime.get(this._nextPrime++);
		for (let i=0; i<this._nextPrime+1; ++i) {
			this._lastComposite++;
			while (Prime.is(this._lastComposite)) this._lastComposite++;
			this._list.push(this._lastComposite);
		}

		this._list.push(pp);
	},

	get : function(n) {
		while (!this._list[n]) this._grow();
		return this._list[n];
	},
});

sequences.set("Bad Reverse Mathatrutgers", {
	_list : [0,1],
	_nextPrime : 0,
	_lastComposite : 1,
	_grow : function() {
		let pp = Prime.get(this._nextPrime++);
		let temp = [];
		for (let i=0; i<this._nextPrime+1; ++i) {
			this._lastComposite++;
			while (Prime.is(this._lastComposite)) this._lastComposite++;
			temp.push(this._lastComposite);
		}
		while (temp.length) this._list.push(temp.pop());

		this._list.push(pp);
	},

	get : function(n) {
		while (!this._list[n]) this._grow();
		return this._list[n];
	},
});


////////////////////////////////////////////////////////////////////////////////////////////////////

var coordsystems = new Map;

// given a coordinate, returns the number in it. Square-shaped version
coordsystems.set("Square", (x,y)=>{
	let loop = Math.max(Math.abs(x),Math.abs(y));
	let start = (2*loop-1)*(2*loop-1)+1;

	if (!x && !y) return 1;

	if (x === loop && y !== loop) return start-y+loop-1;
	if (y === -loop) return start-x+3*loop-1;
	if (x === -loop) return start+y+5*loop-1;
	return start+x+7*loop-1;
});

// given a coordinate, returns the number in it. Diamond-shaped version
coordsystems.set("Diamond", (x,y)=>{
	let loop = Math.abs(x)+Math.abs(y);
	let start = 4*loop*(loop-1)/2+2;

	if (!x && !y) return 1;

	if (x>0 && y>=0) return start+x-1;
	if (x>0) return start+2*loop-x-1;
	if (y<0) return start+3*loop+y-1;
	return start+4*loop+x-1;
});

////////////////////////////////////////////////////////////////////////////////////////////////////

var chosenSequence = null;
var chosenCoords = null;
function getNum(x,y) {
	return chosenSequence.get( chosenCoords(x,y) );
}

////////////////////////////////////////////////////////////////////////////////////////////////////

var visited = null;
function solve(max=1000000, echo=false) {
	let posX = document.getElementById("iniX").value;
	let posY = document.getElementById("iniY").value;
	if (!posX.match(/^-?\d+$/)) return;
	if (!posY.match(/^-?\d+$/)) return;
	posX = +posX;
	posY = +posY;
	let iniNum = getNum(posX,posY);

	let bestN, bestX, bestY;
	let path = [];

	let step = 1;
	visited = new Set();
	visited.add(iniNum);
	path.push(iniNum);
	if (echo) console.log(`${step}. (${posX},${posY}): ${iniNum}`);

	function tryNext(x,y) {
		let num = getNum(x,y);
		if (visited.has(num)) return;

		if (bestN && num > bestN) return;
		bestN = num;
		bestX = x;
		bestY = y;
	}

	while (--max) {
		bestN = bestX = bestY = 0;
		tryNext(posX-1,posY-2);
		tryNext(posX-1,posY+2);
		tryNext(posX+1,posY-2);
		tryNext(posX+1,posY+2);
		tryNext(posX-2,posY-1);
		tryNext(posX-2,posY+1);
		tryNext(posX+2,posY-1);
		tryNext(posX+2,posY+1);
		if (!bestN) break;
		step++;
		posX = bestX;
		posY = bestY;
		visited.add(bestN);
		path.push(bestN);
		if (echo) console.log(`${step}. (${bestX},${bestY}): ${bestN}`);
	}

	let result = (bestN ? "still free" : "trapped") + ` after step #<b>${step}</b> at (${posX},${posY}): <b>${getNum(posX,posY)}</b>`;
	document.getElementById("result").innerHTML = result + "<hr>PATH: " + path.join(", ") + (bestN ? "..." : ".");
}

////////////////////////////////////////////////////////////////////////////////////////////////////

var showSize = 5;
var showX = 0;
var showY = 0;
function showBoard() {
	let table = document.getElementById("spiral");
	table.innerHTML = "";
	for (let dy=-showSize;dy<=showSize;++dy) {
		let tr = document.createElement("tr");
		for (let dx=-showSize;dx<=showSize;++dx) {
			let td = document.createElement("td");
			let n = getNum(dx+showX,dy+showY);
			td.textContent = n;
			if (!visited.has(n)) td.style.color = "red";
			tr.appendChild(td);
		}
		table.appendChild(tr);
	}

	document.getElementById("moveCoords").textContent = `view centered at (${showX},${showY})`;
}

////////////////////////////////////////////////////////////////////////////////////////////////////

sequences.forEach((func,name)=>{
	let opt = document.createElement("option");
	opt.text = name;
	opt.value = name;
	document.getElementById("selSeq").add(opt);
});
coordsystems.forEach((func,name)=>{
	let opt = document.createElement("option");
	opt.text = name;
	opt.value = name;
	document.getElementById("selCoord").add(opt);
});


function run() {
	chosenSequence = sequences.get( document.getElementById("selSeq").value );
	chosenCoords = coordsystems.get( document.getElementById("selCoord").value );
	solve(1000000, false);
	showBoard();
}
run();


</script></body></html>
